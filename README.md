<h1 name="content" align="center"><a href=""></a> MSSQL</h1>

<p align="center">
  <a href="#lab1"><img alt="lab1" src="https://img.shields.io/badge/Lab1-ffb6c1"></a> 
  <a href="#lab2"><img alt="lab2" src="https://img.shields.io/badge/Lab2-ff91a4"></a>
  <a href="#lab3"><img alt="lab3" src="https://img.shields.io/badge/Lab3-ff69b4"></a>
  <a href="#lab4"><img alt="lab4" src="https://img.shields.io/badge/Lab4-ff1493"></a>
  <a href="#lab5"><img alt="lab5" src="https://img.shields.io/badge/Lab5-db7093"></a>
  <a href="#lab6"><img alt="lab6" src="https://img.shields.io/badge/Lab6-c71585"></a> 
  <a href="#lab7"><img alt="lab7" src="https://img.shields.io/badge/Lab7-ffc0cb"></a>
  <a href="#lab8"><img alt="lab8" src="https://img.shields.io/badge/Lab8-d87093"></a>
</p>

Аптека (Вариант №11)
<p aligh="justify>
<h3>
  <a href="#client"></a>
  
  Информация о лекарствах: Название лекарства,  показания к применению, аннотация лекарства, производитель, основное действующее вещество, кол-во в данной аптеке, цена за ед., срок годности.
  
  Продажи: список лекарств и количество каждого лекарства, дата продажи, общая сумма, фамилия касссира.
  
  Заказы: список лекарств и количество каждого лекарства, сумма заказа, дата заказа.

  Реализовать:
- Вывод прайс-листа по разделам лекарств;
- Поиск лекарства по различным параметрам (название, болезнь, производитель, основное действующее вещество);
- Поиск лекарств от заданной болезни
- Подбор более дешевого лекарства с тем же основным действующим веществом;
- Список наиболее часто покупаемых лекарств;
- Если какое-то лекарство закончилось, то автоматическое занесение его в книгу заказов.
- Поиск лекарств с истекшим сроком годности;
- Посчет выручки аптеки за заданный период
</h3>
</p>

<a id="lab1"></a>
# Лабораторная работа №1
[Назад](#content)


Разработать ER-модель данной предметной области: выделить сущности, их атрибуты, связи между сущностями.

Для каждой сущности указать ее имя, атрибут (или набор атрибутов), являющийся первичным ключом, список остальных атрибутов.

Для каждого атрибута указать его тип, ограничения, может ли он быть пустым, является ли он первичным ключом.

Для каждой связи между сущностями указать:
- тип связи (1:1, 1:M, M:N)
- обязательность
- 
ER-модель д.б. представлена в виде ER-диаграммы (картинка)
По имеющейся ER-модели создать реляционную модель данных и отобразить ее в виде списка сущностей с их атрибутами и типами атрибутов, для атрибутов указать, явл. ли он первичным или внешним ключом


#### ER-модель
![image](/lab1/ER_1.png)

#### Реляционная модель
![image](/lab1/2.png)

<a id="lab2"></a>
# Лабораторная работа №2
[Назад](#content)


В соответствии с реляционной моделью данных, разработанной в Лаб.№1, создать реляционную БД на учебном сервере БД :
- создать таблицы, определить первичные ключи и иные ограничения
- определить связи между таблицами
- создать диаграмму
- заполнить все таблицы адекватной информацией (не меньше 10 записей в таблицах, наличие примеров для связей типа 1:M )


[SQL-код создания таблиц](https://github.com/rrakhimovva/db_labs/blob/main/lab2/SQLQuery1.sql)

#### Диаграмма базы данных
![image](/lab1/diagram_bd.jpg)

<a id="lab3"></a>
# Лабораторная работа №3
[Назад](#content)

Цель: изучить конструкции языка SQL для манипулирования данными в СУБД  MSSQL.

Краткое описание работы:
1. Выборка из одной таблицы
2. Выборка из нескольких таблиц
3. Представления
4. Функции ранжирования
5. Объдинение, пересечение, разность
6. Использование CASE, PIVOT и UNPIVOT

[Часть 1](https://github.com/rrakhimovva/db_labs/blob/main/lab3/Рахимова_ПМИ32_часть1.docx)

[Часть 2](https://github.com/rrakhimovva/db_labs/blob/main/lab3/Рахимова_ПМИ32_часть2.docx)

<a id="lab4"></a>
# Лабораторная работа №4
[Назад](#content)

Создать 4 различных [хранимых процедуры](https://github.com/rrakhimovva/db_labs/blob/main/lab4/Хранимые%20процедуры.pdf):
1. Процедура без параметров, формирующая список лекарств, для которых срок годности заканчивается меньше, чем через 1 месяц
2. Процедура, на входе получающая название основного действующего вещества и формирующая список лекарств с этим действующим веществом, упорядоченный по возрастанию цены в виде: название лекарства, цена, производитель
3. роцедура, на входе получающая название лекарства, выходной параметр – самый дешевый его аналог с тем же действующим веществом
4. Процедура, вызывающая вложенную процедуру, которая подсчитывает среднее количество наименований лекарств для одной продажи, а сама выводит продажи с количеством лекарств, превышающим среднее в виде: номер продажи, дата, сумма, кассир
	
Создать 3 [пользовательских функции](https://github.com/rrakhimovva/db_labs/blob/main/lab4/Пользовательские%20функции.pdf):
1. Скалярная функция, возвращающая выручку аптеки на заданную дату
2. Inline-функция, возвращающая список лекарств и их количество, проданных на заданную дату
3. Multi-statement-функция, выдающая список лекарств от заданной болезни, имеющихся в аптеке с указанием количества упаковок
	
Создать 3 [триггера](https://github.com/rrakhimovva/db_labs/blob/main/lab4/Триггеры.pdf):
1. Триггер любого типа на добавление лекарства в заказ: при добавлении нового лекарства проверить, сформирован ли уже заказ на сегодня, если нет, то создать новый заказ на текущую дату и добавить туда лекарство. Если на сегодня заказ есть, то лекарство добавляется к нему
2. Последующий триггер на изменение количества лекарства в аптеке – если количество упаковок лекарства < 3, формируем строку с заказом на это лекарство
3. Замещающий триггер на операцию удаления лекарства из списка купленных покупателем лекарств – если покупатель передумал покупать только что купленное лекарство, то выполняем операцию возврата (удаляем это лекарство из списка купленных этим покупателем лекарств, возвращаем его в аптеку, пересчитываем сумму чека для покупателя)

<a id="lab5"></a>
# Лабораторная работа №5
[Назад](#content)

[Задание 1.](https://github.com/rrakhimovva/db_labs/blob/main/lab5/Task1.sql)
Для БД, созданной в Лаб.раб. 1-2, создать 2 роли:
- 1-я роль должна иметь доступ к таблицам, хр. процедурам и др. объектам БД, требующийся для руководителя фирмы (т.е., ему д.б. разрешено просматривать конфиденциальную информацию, удалять, исправлять какие-то сведения, выполнять процедуры и функции). Некоторые права необходимо предоставить с возможностью дальнейшей передачи.
- 2-я роль должна иметь доступ, требующийся для простого сотрудника (просмотр не всей инф-ии, добавление, изменение, удаление – только того, что нужно для работы, выполнение ограниченного набора процедур и функции).

Включить 2-х пользователей, предварительно созданных для каждого студента администратором БД, в эти роли и проверить, что права ролей выполняются для каждого пользователя (для этого под каждым пользователем подключиться к БД).
Необходимо уметь предоставлять права на объекты любого типа, отзывать выданные права, давать полный запрет на выполнение некоторых действий. (через команды T-SQL и интерфейс SQL Server Management Studio (SSMS))

[Задание 2.](https://github.com/rrakhimovva/db_labs/blob/main/lab5/Task2.sql)
Выполнить маскирование некоторых поле Ваших таблиц  2-мя различными методами:
1. ALTER COLUMN LastName ADD MASKED WITH (FUNCTION = 'partial(2,"xxxx",0)')
2. Используя механизмы представлений, хранимых процедур и функций. Члены 1 роли должны видеть оригинальные данные, члены 2 роли маскированные.

<a id="lab6"></a>
# Лабораторная работа №6
[Назад](#content)

Используя реляционную БД из лабораторной работы №2:
- продумать и создать графовые таблицы по реляционной БД, заполнить графовые таблицы, используя данные в реляционных таблицах
- написать запросы из задания 3.2 используя паттерн MATCH
- сравнить полученные результаты с результатами запросов к реляционной модели
- создать схему узлов и ребер

[SQL-код создания и заполнения графовых таблиц](https://github.com/rrakhimovva/db_labs/blob/main/lab6/Create_graph_tables.sql)

[Сравнение запросов](https://github.com/rrakhimovva/db_labs/blob/main/lab6/Сравнение_запросов%20(1).pdf)

#### Схема узлов и ребер
![image](https://github.com/rrakhimovva/db_labs/blob/main/lab6/Схема%20ребер%20и%20узлов.png)

<a id="lab7"></a>
# Лабораторная работа №7
[Назад](#content)

Цель: используя данные базы данных, подготовленной в предыдущей лабораторной работе, подготовить и реализовать серию запросов, связанных с выборкой информации и модификацией данных таблиц.

Задание 1. Используя базу, полученную в лабораторной 2, создать транзакцию, произвести ее откат и фиксацию. Показать, что данные существовали до отката, удалились после отката, снова были добавлены, и затем были успешно зафиксированы. При необходимости использовать точки сохранения и вложенные транзакции.

```
-- Начинаем транзакцию
BEGIN TRANSACTION;

-- Добавляем нового производителя
INSERT INTO Manufacturer([name], email, [address]) VALUES
('Atrium', 'orders@aytr.ru', ' Краснодар, ул. им. Калинина, д. 58');

-- Создаем точку сохранения
SAVE TRANSACTION savepoint1;

-- Добавляем еще одного производителя
INSERT INTO Manufacturer([name], email, [address]) VALUES
('ICDMC', 'orders@ICDMC.ru', ' Тула, пр-кт Красноармейский, д.1');

-- Откатываем транзакцию до точки сохранения
ROLLBACK TRANSACTION savepoint1;

-- Проверяем, что данные второго производителя были удалены после отката
SELECT * FROM Manufacturer WHERE [name] IN ('Atrium', 'ICDMC');
```

| id | name | email | address |
| :--- | :--- | :--- | :--- |
| 12 | Atrium | orders@aytr.ru |  Краснодар, ул. им. Калинина, д. 58 |

```
-- Cнова добавляем второго производителя
INSERT INTO Manufacturer([name], email, [address]) VALUES
('ICDMC', 'orders@ICDMC.ru', ' Тула, пр-кт Красноармейский, д.1');

-- Фиксируем транзакцию
COMMIT TRANSACTION;

-- Проверяем, что данные обоих производителей были успешно зафиксированы
SELECT * FROM Manufacturer WHERE [name] IN ('Atrium', 'ICDMC');
```
| id | name | email | address |
| :--- | :--- | :--- | :--- |
| 12 | Atrium | orders@aytr.ru |  Краснодар, ул. им. Калинина, д. 58 |
| 13 | ICDMC | orders@ICDMC.ru |  Тула, пр-кт Красноармейский, д.1 |


Задание 2. Подготовить SQL-скрипты для выполнения проверок изолированности транзакций. Скрипты должны работать с одной из таблиц, созданных в лабораторной работе №2.

### READ UNCOMMITTED

```
-- Устанавливаем в обоих сеансах уровень изоляции READ UNCOMMITTED
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
```

```
-- Грязное чтение
# В сессии 1: открыта транзакция с UPDATE, изменения не зафиксированы
# В сессии 2: выполнен SELECT к изменяемым данным
# Результат: сессия 2 увидела незафиксированные изменения из сессии 1, что является грязным чтением.
-- Первое окно
BEGIN TRANSACTION;
UPDATE Manufacturer SET [name] = 'Dirty Read' WHERE id_client = 3;
-- Второе окно
SELECT * FROM Manufacturer WHERE id = 3;
-- Первое окно
ROLLBACK TRANSACTION;
```

| id | name | email | address |
| :--- | :--- | :--- | :--- |
| 3 | Dirty Read | pharma@novartis.ru | Москва, Кутузовский пр-т, 15 |
